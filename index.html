<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Cell Calculator</title>

<style>
:root { color-scheme: light dark; }

body{
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",Arial,sans-serif;
  margin:0;
  background:#000;
}

.wrap{ max-width:980px; margin:0 auto; padding:16px; }
h1{ font-size:20px; margin:8px 0 6px; }
.version{ font-size:12px; opacity:.7; margin-bottom:14px; }

.card{
  border:1px solid rgba(127,127,127,.35);
  border-radius:16px;
  padding:18px;
  margin:20px 0;
}

label{ font-size:12px; opacity:.8; display:block; margin-bottom:6px; }

input,select,button,textarea{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid rgba(127,127,127,.35);
  background:transparent;
  font-size:15px;
  color:inherit;
}

textarea{ min-height: 64px; resize: vertical; }

button{ cursor:pointer; }

.grid2{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
.grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:14px; }

.out{
  font-size:20px;
  font-weight:600;
  margin-top:8px;
  font-variant-numeric:tabular-nums;
}

.sub{
  font-size:12px;
  opacity:.75;
  margin-top:6px;
  line-height:1.4;
}

.pill{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid rgba(127,127,127,.35);
  font-size:12px;
  margin-bottom:6px;
}

.table{
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
  font-variant-numeric:tabular-nums;
}

.table th,.table td{
  text-align:left;
  padding:10px 8px;
  border-bottom:1px solid rgba(127,127,127,.22);
  vertical-align:top;
}

.badge-ok{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(127,127,127,.35);
  font-size:12px;
  margin-left:6px;
}

.badge-warn{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(255,180,0,.6);
  font-size:12px;
  margin-left:6px;
}

hr.sep{
  border:0;
  border-top:1px solid rgba(127,127,127,.25);
  margin:18px 0;
}

@media (max-width: 820px){
  .grid2,.grid3{ grid-template-columns:1fr; }
}
</style>
</head>

<body>
<div class="wrap">
  <h1>Cell Calculator</h1>
  <div class="version">Version: 2026-01-14 14:20</div>

  <!-- 1) Concentration + total cells -->
  <div class="card">
    <div class="grid2">
      <div>
        <label>Concentration source</label>
        <select id="mode">
          <option value="hemo" selected>Hemocytometer (Neubauer)</option>
          <option value="known">Concentration known</option>
        </select>
      </div>
      <div>
        <label>Note</label>
        <input disabled value="Neubauer: (counts/squares) × dilution × 10^4 = cells/mL">
      </div>
    </div>

    <div id="hemoBox" class="grid3" style="margin-top:16px;">
      <div>
        <label>Counted cells (sum)</label>
        <input id="counts" value="250">
      </div>
      <div>
        <label>Squares</label>
        <input id="squares" value="4">
      </div>
      <div>
        <label>Dilution factor</label>
        <input id="dilution" value="1">
      </div>
    </div>

    <div id="knownBox" class="grid2" style="margin-top:16px; display:none;">
      <div>
        <label>Concentration</label>
        <input id="concVal" value="6.25e5">
      </div>
      <div>
        <label>Unit</label>
        <select id="concUnit">
          <option value="ml" selected>cells/mL</option>
          <option value="ul">cells/µL</option>
        </select>
      </div>
    </div>

    <div class="grid2" style="margin-top:16px;">
      <div>
        <label>Current suspension volume (mL)</label>
        <input id="suspVolML" value="5">
      </div>
      <div>
        <label>Total cells</label>
        <div class="out" id="totalCellsOut">–</div>
        <div class="sub" id="totalCellsSub"></div>
      </div>
    </div>

    <div style="margin-top:16px;">
      <span class="pill">Concentration</span>
      <div class="out" id="concOut">–</div>
    </div>
  </div>

  <!-- 2) Plating -->
  <div class="card">
    <div class="grid3">
      <div>
        <label>Target cells (per well/dish)</label>
        <input id="targetCells" value="200000">
      </div>
      <div>
        <label>Final volume (mL)</label>
        <input id="finalVol" value="">
      </div>
      <div>
        <label>Preset (sorted small → large)</label>
        <select id="preset">
          <option value="">no preset</option>
          <option value="0.2">96-well (0.2 mL)</option>
          <option value="0.3">8-well (0.3 mL)</option>
          <option value="0.5">24-well (0.5 mL)</option>
          <option value="1.0">12-well (1.0 mL)</option>
          <option value="3.0">6-well (3.0 mL)</option>
        </select>
      </div>
    </div>

    <div class="grid2" style="margin-top:18px;">
      <div>
        <span class="pill">Add cell suspension</span>
        <div class="out" id="pipOut">–</div>
        <div class="sub" id="pipSub"></div>
      </div>
      <div>
        <span class="pill">Top up with medium</span>
        <div class="out" id="medOut">–</div>
        <div class="sub">to final volume</div>
      </div>
    </div>

    <div class="grid2" style="margin-top:18px;">
      <button id="copyPlateBtn">Copy plating volume</button>
      <button id="resetBtn">Reset</button>
    </div>
  </div>

  <!-- 3) Cryo -->
  <div class="card">
    <div class="grid2">
      <div>
        <label>Mode</label>
        <select id="cryoMode">
          <option value="single">Single vial from current suspension (take volume)</option>
          <option value="pellet" selected>From full pellet (resuspend once, then aliquot)</option>
        </select>
      </div>
      <div>
        <label>Final volume per cryovial (mL)</label>
        <input id="cryoVolML" value="1.0">
      </div>
    </div>

    <hr class="sep">

    <!-- Cryo: Single -->
    <div id="cryoSingleBox" style="display:none;">
      <div class="sub">
        You take a volume from the current suspension that contains the requested cell number. If the taken volume is larger than the cryovial final volume, pellet and resuspend to the cryovial volume.
      </div>

      <table class="table">
        <thead>
          <tr>
            <th>Target (cells)</th>
            <th>Take from suspension</th>
            <th>Then</th>
          </tr>
        </thead>
        <tbody id="cryoSingleTable"></tbody>
      </table>

      <div class="grid2" style="margin-top:18px;">
        <button id="copyCryoSingle1M">Copy 1,000,000 target</button>
        <button id="copyCryoSingleAll">Copy all targets</button>
      </div>
    </div>

    <!-- Cryo: Pellet (prioritize 1,000,000 vials) -->
    <div id="cryoPelletBox">
      <div class="sub">
        Workflow: pellet all cells, discard supernatant, resuspend once, then aliquot into cryovials. This mode prioritizes making as many <strong>1,000,000-cells</strong> cryovials as possible.
      </div>

      <div class="grid2" style="margin-top:14px;">
        <div>
          <label>Priority target per vial (cells)</label>
          <input id="priorityCells" value="1000000">
          <div class="sub">Default is 1,000,000 cells per vial.</div>
        </div>
        <div>
          <label>Aliquot volume you want to pipette (mL)</label>
          <input id="aliquotVolML" value="1.0">
          <div class="sub">
            If you set this to 1.0 mL, the tool suggests a resuspension that gives exactly 1,000,000 cells per 1.0 mL.
          </div>
        </div>
      </div>

      <div style="margin-top:16px;">
        <span class="pill">Result</span>
        <div class="out" id="pelletMainOut">–</div>
        <div class="sub" id="pelletMainSub"></div>
      </div>

      <table class="table" style="margin-top:12px;">
        <thead>
          <tr>
            <th>What to do</th>
            <th>Value</th>
          </tr>
        </thead>
        <tbody id="pelletStepsTable"></tbody>
      </table>

      <div class="grid2" style="margin-top:18px;">
        <button id="copyPelletSummaryBtn">Copy cryo summary</button>
        <button id="copyPelletResuspBtn">Copy resuspension volume</button>
      </div>
    </div>

  </div>
</div>

<script>
const $ = id => document.getElementById(id);
const num = v => Number(String(v).replace(",", "."));

function concPerML(){
  if ($("mode").value === "hemo"){
    const c = num($("counts").value);
    const s = num($("squares").value);
    const d = num($("dilution").value) || 1;
    return s > 0 ? (c / s) * d * 1e4 : 0;
  } else {
    const v = num($("concVal").value);
    return $("concUnit").value === "ul" ? v * 1000 : v;
  }
}

function fmtInt(n){
  if (!isFinite(n) || n <= 0) return "–";
  return Math.round(n).toLocaleString("en-US");
}

// All outputs in µL, and if ≥ 1000 µL show mL (with 3 decimals).
// Internally we format from µL.
function fmtVolFromUL(uL){
  if (!isFinite(uL) || uL <= 0) return "–";
  if (uL >= 1000) return `${(uL/1000).toFixed(3)} mL`;
  return `${Math.round(uL)} µL`;
}

function recompute(){
  // show/hide concentration inputs
  $("hemoBox").style.display = $("mode").value === "hemo" ? "grid" : "none";
  $("knownBox").style.display = $("mode").value === "known" ? "grid" : "none";

  // base values
  const c = concPerML(); // cells/mL
  const suspV_mL = num($("suspVolML").value);
  const totalCells = (c > 0 && suspV_mL > 0) ? c * suspV_mL : 0;

  $("concOut").textContent = c > 0 ? `${c.toExponential(3)} cells/mL` : "–";
  $("totalCellsOut").textContent = totalCells > 0 ? `${fmtInt(totalCells)} cells` : "–";
  $("totalCellsSub").textContent =
    totalCells > 0 ? `${c.toExponential(3)} × ${suspV_mL.toFixed(2)} mL` : "";

  // plating
  const target = num($("targetCells").value);
  const vol_uL_exact = (c > 0 && target > 0) ? (target / c) * 1000 : 0;
  const vol_uL = Math.round(vol_uL_exact); // 1 µL resolution

  $("pipOut").textContent = vol_uL > 0 ? fmtVolFromUL(vol_uL) : "–";
  $("pipSub").textContent = vol_uL > 0 ? `exact: ${vol_uL_exact.toFixed(2)} µL` : "";

  const finalV_mL = num($("finalVol").value);
  const final_uL = (finalV_mL > 0) ? finalV_mL * 1000 : 0;
  const med_uL = (final_uL > 0 && vol_uL > 0) ? Math.max(0, final_uL - vol_uL) : 0;

  $("medOut").textContent = (final_uL > 0 && vol_uL > 0) ? fmtVolFromUL(med_uL) : "–";

  // cryo mode toggle
  const cryoMode = $("cryoMode").value;
  $("cryoSingleBox").style.display = cryoMode === "single" ? "block" : "none";
  $("cryoPelletBox").style.display = cryoMode === "pellet" ? "block" : "none";

  // Cryo: Single (fixed targets)
  const cryoVol_mL = num($("cryoVolML").value) || 1.0;
  const singleTargets = [1000000, 750000, 500000];
  let singleRows = [];

  if (c > 0 && totalCells > 0){
    for (const t of singleTargets){
      let take = "–";
      let then = "–";

      if (totalCells < t){
        take = `– <span class="badge-warn">not enough cells</span>`;
        then = `<span class="sub">concentrate required</span>`;
      } else {
        const need_uL_exact = (t / c) * 1000;
        const need_uL = Math.round(need_uL_exact); // 1 µL
        take = `${fmtVolFromUL(need_uL)}<div class="sub">exact: ${need_uL_exact.toFixed(2)} µL</div>`;
        then = `${cryoVol_mL.toFixed(2)} mL<br><span class="sub">pellet, resuspend in freezing medium</span>`;

        if (Math.abs(totalCells - t) < 0.5){
          take = `entire suspension <span class="badge-ok">exact match</span>`;
          then = `${cryoVol_mL.toFixed(2)} mL<br><span class="sub">pellet, resuspend</span>`;
        }
      }
      singleRows.push({t, take, then});
    }
  } else {
    for (const t of singleTargets){
      singleRows.push({t, take:"–", then:"–"});
    }
  }

  $("cryoSingleTable").innerHTML = singleRows.map(r => `
    <tr>
      <td><strong>${fmtInt(r.t)}</strong></td>
      <td>${r.take}</td>
      <td>${r.then}</td>
    </tr>
  `).join("");

  // copy strings for single
  const singleCopyLines = singleRows.map(r => `${fmtInt(r.t)}: ${stripHtml(r.take)} -> ${stripHtml(r.then)}`);
  window.__copyCryoSingleAll = singleCopyLines.join("\n");
  window.__copyCryoSingle1M = singleCopyLines[0] || "";

  // Cryo: Pellet (prioritize 1,000,000 vials)
  const priorityCells = num($("priorityCells").value) || 1000000;
  const aliquotVol_mL = num($("aliquotVolML").value) || 1.0;

  // Master concentration chosen so that aliquotVol contains priorityCells.
  // C_master = priorityCells / aliquotVol (cells/mL)
  const C_master = (priorityCells > 0 && aliquotVol_mL > 0) ? (priorityCells / aliquotVol_mL) : 0;

  // Resuspend ALL cells to C_master: V_resusp = totalCells / C_master (mL)
  const V_resusp_mL = (totalCells > 0 && C_master > 0) ? (totalCells / C_master) : 0;

  // How many full priority vials can we make?
  const maxVials = (totalCells > 0 && priorityCells > 0) ? Math.floor(totalCells / priorityCells) : 0;
  const remainingCells = (totalCells > 0 && priorityCells > 0) ? (totalCells - maxVials * priorityCells) : 0;

  // If you resuspend to C_master, then each priority vial aliquot needs aliquotVol_mL.
  const volumePerVial_uL = aliquotVol_mL * 1000;
  const totalNeeded_uL = maxVials * volumePerVial_uL;
  const totalResusp_uL = V_resusp_mL * 1000;
  const remainingVol_uL = totalResusp_uL - totalNeeded_uL; // corresponds to remainingCells at C_master

  if (totalCells > 0 && C_master > 0){
    if (maxVials >= 1){
      $("pelletMainOut").textContent = `${maxVials} vial(s) at ${fmtInt(priorityCells)} cells`;
      $("pelletMainSub").innerHTML =
        `Suggested master concentration: <strong>${C_master.toExponential(3)} cells/mL</strong> so that ` +
        `<strong>${aliquotVol_mL.toFixed(2)} mL</strong> contains <strong>${fmtInt(priorityCells)} cells</strong>. ` +
        `Remaining after ${maxVials} vial(s): <strong>${fmtInt(remainingCells)} cells</strong>.`;
    } else {
      $("pelletMainOut").textContent = `0 vial(s) at ${fmtInt(priorityCells)} cells`;
      $("pelletMainSub").innerHTML =
        `You have <strong>${fmtInt(totalCells)} cells</strong>, which is below the priority target. ` +
        `Even with maximal concentration, you cannot reach one full ${fmtInt(priorityCells)}-cell vial. ` +
        `The suggested resuspension below still gives the most standardized concentration possible.`;
    }

    // Steps table
    const steps = [];

    steps.push({
      k: "Pellet",
      v: "Spin down the entire suspension and discard supernatant"
    });

    steps.push({
      k: "Resuspend pellet in",
      v: `${V_resusp_mL.toFixed(3)} mL (${fmtVolFromUL(totalResusp_uL)})`
    });

    steps.push({
      k: "This gives",
      v: `${C_master.toExponential(3)} cells/mL`
    });

    steps.push({
      k: `Pipette per ${fmtInt(priorityCells)}-cell vial`,
      v: `${aliquotVol_mL.toFixed(3)} mL (${fmtVolFromUL(volumePerVial_uL)})`
    });

    steps.push({
      k: "Number of full vials",
      v: `${maxVials}`
    });

    if (maxVials >= 1){
      steps.push({
        k: "Leftover volume at same concentration",
        v: `${fmtVolFromUL(Math.max(0, remainingVol_uL))} (${fmtInt(remainingCells)} cells)`
      });
    } else {
      // show what one vial would require in volume at this C_master (still aliquotVol) but insufficient cells
      steps.push({
        k: "What you could freeze instead",
        v: `1 vial with ${fmtInt(totalCells)} cells in ${aliquotVol_mL.toFixed(2)} mL (if you accept a lower cell count)`
      });
    }

    $("pelletStepsTable").innerHTML = steps.map(s => `
      <tr><td>${s.k}</td><td><strong>${s.v}</strong></td></tr>
    `).join("");

    // clipboard strings
    window.__copyPelletResusp = `${V_resusp_mL.toFixed(3)} mL`;
    window.__copyPelletSummary =
      `Cryo from full pellet (priority ${fmtInt(priorityCells)} cells)\n` +
      `Total cells: ${fmtInt(totalCells)}\n` +
      `Master concentration: ${C_master.toExponential(3)} cells/mL\n` +
      `Resuspend pellet in: ${V_resusp_mL.toFixed(3)} mL\n` +
      `Aliquot per vial: ${aliquotVol_mL.toFixed(3)} mL\n` +
      `Full vials: ${maxVials}\n` +
      `Remaining cells: ${fmtInt(remainingCells)}`;
  } else {
    $("pelletMainOut").textContent = "–";
    $("pelletMainSub").textContent = "Set concentration and suspension volume to enable calculations.";
    $("pelletStepsTable").innerHTML = "";
    window.__copyPelletResusp = "";
    window.__copyPelletSummary = "";
  }
}

function stripHtml(s){
  const div = document.createElement("div");
  div.innerHTML = s;
  return div.textContent || div.innerText || "";
}

// preset handling
$("preset").onchange = () => {
  if ($("preset").value) $("finalVol").value = $("preset").value;
  recompute();
};

// listeners
[
  "mode","counts","squares","dilution","concVal","concUnit",
  "suspVolML",
  "targetCells","finalVol","cryoMode","cryoVolML",
  "priorityCells","aliquotVolML"
].forEach(id => $(id).addEventListener("input", recompute));

$("copyPlateBtn").onclick = () => navigator.clipboard.writeText($("pipOut").textContent);
$("copyCryoSingle1M").onclick = () => navigator.clipboard.writeText(window.__copyCryoSingle1M || "");
$("copyCryoSingleAll").onclick = () => navigator.clipboard.writeText(window.__copyCryoSingleAll || "");
$("copyPelletSummaryBtn").onclick = () => navigator.clipboard.writeText(window.__copyPelletSummary || "");
$("copyPelletResuspBtn").onclick = () => navigator.clipboard.writeText(window.__copyPelletResusp || "");
$("resetBtn").onclick = () => location.reload();

recompute();
</script>
</body>
</html>
