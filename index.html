<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cell Calculator</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif; margin: 0; }
    .wrap { max-width: 820px; padding: 18px; margin: 0 auto; }
    h1 { font-size: 20px; margin: 6px 0 14px; }
    .card { border: 1px solid rgba(127,127,127,.35); border-radius: 14px; padding: 14px; margin: 12px 0; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    label { font-size: 12px; opacity: .85; display: block; margin-bottom: 6px; }
    input, select { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid rgba(127,127,127,.35); background: transparent; }
    .out { font-variant-numeric: tabular-nums; font-size: 16px; }
    .muted { font-size: 12px; opacity: .75; line-height: 1.35; }
    .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; border: 1px solid rgba(127,127,127,.35); font-size: 12px; opacity: .9; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(127,127,127,.35); background: transparent; }
    .btnrow { display:flex; gap:10px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Cell Calculator</h1>

    <div class="card">
      <div class="row">
        <div>
          <label>Quelle der Konzentration</label>
          <select id="mode">
            <option value="hemo">Hämozytometer (Neubauer, großes Quadrat)</option>
            <option value="known">Konzentration bekannt</option>
          </select>
        </div>
        <div>
          <label>Rundung Pipettiervolumen</label>
          <select id="rounding">
            <option value="1">auf 1 µL</option>
            <option value="5">auf 5 µL</option>
            <option value="10" selected>auf 10 µL</option>
            <option value="25">auf 25 µL</option>
          </select>
        </div>
      </div>

      <div id="hemoBox" style="margin-top:12px;">
        <div class="row3">
          <div>
            <label>Gezählte Zellen (Summe)</label>
            <input id="counts" inputmode="numeric" value="200" />
          </div>
          <div>
            <label>Anzahl großer Quadrate</label>
            <input id="squares" inputmode="numeric" value="4" />
          </div>
          <div>
            <label>Verdünnungsfaktor (z.B. 2 bei 1:1)</label>
            <input id="dilution" inputmode="decimal" value="2" />
          </div>
        </div>
        <p class="muted" style="margin:10px 0 0;">
          Annahme: Neubauer großes Quadrat Volumen = 10⁻⁴ mL (1 mm × 1 mm × 0,1 mm). Daraus folgt der Faktor 10⁴.
        </p>
      </div>

      <div id="knownBox" style="margin-top:12px; display:none;">
        <div class="row">
          <div>
            <label>Konzentration</label>
            <input id="concVal" inputmode="decimal" value="1e6" />
          </div>
          <div>
            <label>Einheit</label>
            <select id="concUnit">
              <option value="perml" selected>Zellen/mL</option>
              <option value="perul">Zellen/µL</option>
            </select>
          </div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="row">
          <div>
            <span class="pill">Konzentration</span>
            <div class="out" id="concOut" style="margin-top:8px;">–</div>
          </div>
          <div>
            <span class="pill">Formel</span>
            <div class="muted" style="margin-top:8px;">
              c [Zellen/mL] = (counts / squares) × dilution × 10⁴
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row3">
        <div>
          <label>Zielzellzahl in der Dish</label>
          <input id="targetCells" inputmode="numeric" value="200000" />
        </div>
        <div>
          <label>Endvolumen in Dish (mL, optional)</label>
          <input id="finalVol" inputmode="decimal" value="2.0" />
        </div>
        <div>
          <label>Preset Endvolumen</label>
          <select id="preset">
            <option value="">kein Preset</option>
            <option value="2.0">6 well typ. 2.0 mL</option>
            <option value="1.0">12 well typ. 1.0 mL</option>
            <option value="0.5">24 well typ. 0.5 mL</option>
            <option value="0.2">96 well typ. 0.2 mL</option>
          </select>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="row">
          <div>
            <span class="pill">Zu pipettieren</span>
            <div class="out" id="pipOut" style="margin-top:8px;">–</div>
            <div class="muted" id="pipOut2" style="margin-top:6px;"></div>
          </div>
          <div>
            <span class="pill">Medium auffüllen</span>
            <div class="out" id="medOut" style="margin-top:8px;">–</div>
            <div class="muted" id="medNote" style="margin-top:6px;"></div>
          </div>
        </div>

        <div class="btnrow" style="margin-top:12px;">
          <button id="copyBtn">Pipettiervolumen kopieren</button>
          <button id="resetBtn">Reset</button>
        </div>
      </div>
    </div>

    <div class="muted">
      Tipp: Wenn du viable only rechnen willst, zählst du bei Trypan Blue nur die lebenden Zellen und lässt den Verdünnungsfaktor wie gehabt.
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  function toNumber(s) {
    if (s === null || s === undefined) return 0;
    return Number(String(s).trim().replace(",", "."));
  }

  function sci(n) {
    if (!isFinite(n) || n <= 0) return "–";
    return n.toExponential(3) + " Zellen/mL";
  }

  function roundToStep(uL, step) {
    if (!isFinite(uL) || uL < 0) return 0;
    return Math.round(uL / step) * step;
  }

  function formatUL(uL) {
    if (!isFinite(uL)) return "–";
    if (uL < 1000) return `${uL.toFixed(uL < 10 ? 2 : 1)} µL`;
    return `${(uL/1000).toFixed(3)} mL`;
  }

  function computeConcPerML() {
    const mode = $("mode").value;
    if (mode === "hemo") {
      const counts = toNumber($("counts").value);
      const squares = toNumber($("squares").value);
      const dilution = toNumber($("dilution").value) || 1;
      if (squares <= 0) return 0;
      return (counts / squares) * dilution * 1e4;
    } else {
      const v = toNumber($("concVal").value);
      const unit = $("concUnit").value;
      return unit === "perul" ? v * 1000 : v;
    }
  }

  function recompute() {
    const mode = $("mode").value;
    $("hemoBox").style.display = (mode === "hemo") ? "block" : "none";
    $("knownBox").style.display = (mode === "known") ? "block" : "none";

    const c = computeConcPerML();
    $("concOut").textContent = sci(c);

    const target = toNumber($("targetCells").value);
    const roundingStep = toNumber($("rounding").value) || 10;

    let vol_mL = 0;
    if (c > 0 && target > 0) vol_mL = target / c;
    let vol_uL = vol_mL * 1000;

    const vol_uL_rounded = roundToStep(vol_uL, roundingStep);

    $("pipOut").textContent = formatUL(vol_uL_rounded);
    $("pipOut2").textContent = (c > 0 && target > 0)
      ? `exakt: ${formatUL(vol_uL)}; gerundet: ${roundingStep} µL Schritte`
      : "–";

    const finalVol = toNumber($("finalVol").value);
    if (finalVol > 0) {
      const med_mL = Math.max(0, finalVol - (vol_uL_rounded/1000));
      $("medOut").textContent = `${med_mL.toFixed(3)} mL`;
      $("medNote").textContent = "Falls du mit Mastermix arbeitest, rechne das Endvolumen entsprechend um.";
    } else {
      $("medOut").textContent = "–";
      $("medNote").textContent = "Endvolumen optional.";
    }
  }

  function resetAll() {
    $("mode").value = "hemo";
    $("counts").value = "200";
    $("squares").value = "4";
    $("dilution").value = "2";
    $("concVal").value = "1e6";
    $("concUnit").value = "perml";
    $("targetCells").value = "200000";
    $("finalVol").value = "2.0";
    $("preset").value = "";
    $("rounding").value = "10";
    recompute();
  }

  $("mode").addEventListener("change", recompute);
  ["counts","squares","dilution","concVal","targetCells","finalVol"].forEach(id => {
    $(id).addEventListener("input", recompute);
  });
  $("concUnit").addEventListener("change", recompute);
  $("rounding").addEventListener("change", recompute);

  $("preset").addEventListener("change", () => {
    const v = $("preset").value;
    if (v) $("finalVol").value = v;
    recompute();
  });

  $("copyBtn").addEventListener("click", async () => {
    const text = $("pipOut").textContent;
    try {
      await navigator.clipboard.writeText(text);
      $("copyBtn").textContent = "Kopiert";
      setTimeout(() => $("copyBtn").textContent = "Pipettiervolumen kopieren", 900);
    } catch {
      $("copyBtn").textContent = "Kopieren nicht möglich";
      setTimeout(() => $("copyBtn").textContent = "Pipettiervolumen kopieren", 900);
    }
  });

  $("resetBtn").addEventListener("click", resetAll);

  recompute();
</script>
</body>
</html>